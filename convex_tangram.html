<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Calculate convex tangrams</title>
	<script src="vector.js"></script>
	<script src="matrix.js"></script>
	<script src="shape.js"></script>
	<script>		
		// --------------------------------------------------------------------
		// class Piece
		// --------------------------------------------------------------------		
		var Piece=function(id, color) { 
			this.path=[];
			// the path is a sequence of length of edges and inner angles
			// the length of the edge can be L for long edges and S for short edges
			// L=sqrt(2) * S
			// the angle can be any value 0-7 were 0=0°, 1=45°, 2=90°, ...
			// [ 'S', 1, 'L', 1, 'S', 2 ] would be tangram's small triangle
			this.id=id; 
			this.color=color 
		};

		Piece.prototype.clone=function() {
			var piece=new Piece(this.id, this.color);
			piece.path=this.path.slice(0); // clone array
			return piece;
		};
		
		Piece.prototype.asString=function() {
			var r="";
			this.path.forEach(function(e) {	r=r+e+" " })
			return r;
		}
		
		Piece.prototype.set_triangle_small=function() {
			this.path=[ 'L', 1, 'S', 2, 'S', 1 ];
			return this;
		};

		Piece.prototype.set_triangle_medium=function() {
			this.path=[ 'L', 1, 'S', 4, 'S', 1, 'L', 2 ];
			return this;
		};

		Piece.prototype.set_triangle_big=function() {
			this.path=[ 'L', 4, 'L', 1, 'S', 4, 'S', 2, 'S', 4, 'S', 1 ];
			return this;
		};

		Piece.prototype.set_square=function() {
			this.path=[ 'S', 2, 'S', 2, 'S', 2, 'S', 2 ];
			return this;
		};


		Piece.prototype.set_parallelogram=function() {
			this.path=[ 'L', 1, 'S', 3, 'L', 1, 'S', 3 ];
			return this;
		};

		Piece.prototype.set_test=function() {
			//this.path=[ 'L', 3, 'S', 3, 'L', 1, 'S', 4, 'S', 4, 'S', 1, ];
			this.path=[ 'S', 4, 'S', 1, 'L', 3, 'S', 3, 'L', 1, 'S', 4, ];
			return this;
		};

		Piece.prototype.combine=function(motherindex, childpiece, childindex) {
			// combine parallelogram L 1 S 3 L 1 S 3 and small triangle L 1 S 2 S 1 with
			// motherindex 2: L 1 |S| 3 L 1 S 3 and childindex 2: L 1 |S| 2 S 1.
			// result shall be L 3 S 1 L 4 L 1 S 3.
			// iterate mother piece until link edge (motherindex), add angle and 
			// continue with childpiece (modulo). 
			// At the end of the child piece add angles and continue with rest of mother piece.
			if(this.path[motherindex]!=childpiece.path[childindex]) throw "incompatible edges";
			var combination=new Piece(this.id, this.color);
			var mimod=0;
			// iterate mother piece until link edge and copy path
			for(var mi=0; mi < motherindex; mi++) 
				combination.path.push(this.path[mi]);
			// add angle
			if(combination.path.length>1)
				combination.path[combination.path.length-1]+=childpiece.path[childindex+1]; 
			else
				mimod = 2;
			// iterate childpiece (modulo) beginning from link edge
			for(var ci=childindex+2, i=0; i++<childpiece.path.length-2; ci=(ci+1)%childpiece.path.length) 
				combination.path.push(childpiece.path[ci]);
			// add angle
			combination.path[combination.path.length-1] += this.path[motherindex+1]; 
			// continue with rest of mother piece
			for(var mi=motherindex+2, i=0; i++<this.path.length-4+mimod; mi=(mi+1)%this.path.length) 
				combination.path.push(this.path[mi]);
			if(mimod!=0) 
				combination.path[combination.path.length-1]+=childpiece.path[childindex+1]; 

			return combination;
		};
		 
		Piece.prototype.toShape=function(id, color) {
			var shape=new Shape(id, color);
			if(this.path.length == 0) return shape;
			var angle=0;
			if(this.path[0]="S") angle += 1;
			var v=new Vector(0, 0);
			for(var i=1; i<this.path.length; i=i+2) {
				angle=(angle+4-this.path[i])%8;
				v.add(Vector.get_vector_for_angle(angle));
				shape.n.push(v.clone()); 
				// console.log("i="+i+"  angle="+this.path[i]+"  cangle="+angle+"   v:"+v.asString());
			}
			return shape;
		};

		function start() {	
			/*
			// combine parallelogram and small triangle (works)
			var p1=new Piece();
			p1.set_parallelogram();
			var p2=new Piece();
			p2.set_triangle_small();
			var p3=p1.combine(2, p2, 2);
			*/
			
			/*
			// combine parallelogram and medium triangle (works)
			var p1=new Piece();
			p1.set_parallelogram();
			var p2=new Piece();
			p2.set_triangle_medium();
			var p3=p1.combine(4, p2, 0);
			*/

			/*
			// combine parallelogram and medium triangle, 0 on 0 (works)
			var p1=new Piece();
			p1.set_parallelogram();
			var p2=new Piece();
			p2.set_triangle_medium();
			var p3=p1.combine(0, p2, 0);
			*/
			
			// combine parallelogram and medium triangle, 0 on 0 (doesn't work, debug)
			var p1=new Piece();
			p1.set_parallelogram();
			var p2=new Piece();
			p2.set_triangle_medium();
			var p3=p1.combine(0, p2, 6);
			
			console.log("p3: "+p3.asString());
			// transform piece to shape to draw it
			var s=p3.toShape(0, "#fa6666");
			// create a transformation matrix to transform the shape in a display-able format
			Matrix.get_translation(200, 200)
				.multiply_matrix(Matrix.get_scale(-32, 32))
				.multiply_matrix(Matrix.get_rotate(Math.PI+0.085))
				.transform_shape(s);
			// draw it on canvas
			var ctx=document.getElementById("mainCanvas").getContext("2d");
			s.draw(ctx);
		}
	</script>
</head>


<body onload="start();">
	<canvas id="mainCanvas" width="1000" height="600" style="border:1px solid #000000;">
	</canvas>
</body>

</html>